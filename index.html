<html>
  <head>
    <style>
      .loading-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: #007bff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      }

      @keyframes spin {
      to {
      transform: rotate(360deg);
      }
      }
    </style>
    <style>
    #check {
    display: inline-block;
    text-align: left;
    }
    </style>
    <style>
      #app{
      float:center;
      width:50%;
      height:50%;
      position:relative;
      }
    </style>
    <style>
      #drop-area1 {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 400px;
      height: 100px;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      text-align: center;
      }
    </style>

    <style>
      #drop-area2 {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 400px;
      height: 100px;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      text-align: center;
      }
    </style>
    
  </head>
  <body>


    <div id="drop-area1">Drag and drop 1st pdb file here, or click to select 1st pdb file</div>

    <div id="drop-area2">Drag and drop 2nd pdb file here, or click to select 2nd pdb file</div>

    <script>

      let pdb1="";
      let filename1="dummy1.pdb";
      const dropArea1 = document.getElementById('drop-area1');
      dropArea1.addEventListener('dragenter', handleDragEnter1, false);
      dropArea1.addEventListener('dragleave', handleDragLeave1, false);
      dropArea1.addEventListener('dragover', handleDragOver1, false);
      dropArea1.addEventListener('drop', handleDrop1, false);
      dropArea1.addEventListener('click', handleClick1, false);

      function handleDragEnter1(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea1.style.background = '#eee';
      }

      function handleDragLeave1(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea1.style.background = '#fff';
      }

      function handleDragOver1(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea1.style.background = '#eee';
      }

      function handleDrop1(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea1.style.background = '#fff';
      const file = event.dataTransfer.files[0];
      const reader = new FileReader();

      // Check if the file name ends with ".gz"
      if (file.name.endsWith('.gz')) {
      reader.onload = function (event) {
      const compressedData = event.target.result;

      // Decompress the data using Pako
      const decompressed = pako.inflate(compressedData, { to: 'string' });
      console.log(decompressed);

      // Store the decompressed data
      pdb1 = decompressed;
      filename1 = file.name.replace("\.gz","");
      };

      // Read the file as an array buffer
      reader.readAsArrayBuffer(file);
      } else {
      reader.onload = function (event) {
      const content = event.target.result;

      // Output the file contents to the console
      console.log(content);

      // Store the file contents
      pdb1 = content;
      filename1 = file.name
      };

      // Read the file as text
      reader.readAsText(file);
      }

      dropArea1.textContent = file.name;           
      }

      function handleClick1(event) {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      // Check if the file name ends with ".gz"
      if (file.name.endsWith('.gz')) {
      reader.onload = function (event) {
      const compressedData = event.target.result;

      // Decompress the data using Pako
      const decompressed = pako.inflate(compressedData, { to: 'string' });
      console.log(decompressed);

      // Store the decompressed data
      pdb1 = decompressed;
      filename1 = file.name.replace("\.gz","");
      };

      // Read the file as an array buffer
      reader.readAsArrayBuffer(file);
      } else {
      reader.onload = function (event) {
      const content = event.target.result;

      // Output the file contents to the console
      console.log(content);

      // Store the file contents
      pdb1 = content;
      filename1 = file.name
      };

      // Read the file as text
      reader.readAsText(file);
      }

      dropArea1.textContent = file.name;     
      };

      input.click();
      }
      
    </script>

    <script src="https://cdn.jsdelivr.net/npm/pako/dist/pako.min.js"></script>
    <script>
      let pdb2="";
      let filename2="dummy.pdb";
      const dropArea2 = document.getElementById('drop-area2');
      dropArea2.addEventListener('dragenter', handleDragEnter2, false);
      dropArea2.addEventListener('dragleave', handleDragLeave2, false);
      dropArea2.addEventListener('dragover', handleDragOver2, false);
      dropArea2.addEventListener('drop', handleDrop2, false);
      dropArea2.addEventListener('click', handleClick2, false);

      function handleDragEnter2(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea2.style.background = '#eee';
      }

      function handleDragLeave2(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea2.style.background = '#fff';
      }

      function handleDragOver2(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea2.style.background = '#eee';
      }

      function handleDrop2(event) {
      event.stopPropagation();
      event.preventDefault();
      dropArea1.style.background = '#fff';
      const file = event.dataTransfer.files[0];
      const reader = new FileReader();

      // Check if the file name ends with ".gz"
      if (file.name.endsWith('.gz')) {
      reader.onload = function (event) {
      const compressedData = event.target.result;

      // Decompress the data using Pako
      const decompressed = pako.inflate(compressedData, { to: 'string' });
      console.log(decompressed);

      // Store the decompressed data
      pdb2 = decompressed;
      filename2 = file.name.replace("\.gz","");
      };

      // Read the file as an array buffer
      reader.readAsArrayBuffer(file);
      } else {
      reader.onload = function (event) {
      const content = event.target.result;

      // Output the file contents to the console
      console.log(content);

      // Store the file contents
      pdb2 = content;
      filename2 = file.name;
      };

      // Read the file as text
      reader.readAsText(file);
      }

      dropArea2.textContent = file.name;
      }

      function handleClick2(event) {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = function (event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      // Check if the file name ends with ".gz"
      if (file.name.endsWith('.gz')) {
      reader.onload = function (event) {
      const compressedData = event.target.result;

      // Decompress the data using Pako
      const decompressed = pako.inflate(compressedData, { to: 'string' });
      console.log(decompressed);

      // Store the decompressed data
      pdb2 = decompressed;
      filename2 = file.name.replace("\.gz","");
      };

      // Read the file as an array buffer
      reader.readAsArrayBuffer(file);
      } else {
      reader.onload = function (event) {
      const content = event.target.result;

      // Output the file contents to the console
      console.log(content);

      // Store the file contents
      pdb2 = content;
      filename2 = file.name;
      };

      // Read the file as text
      reader.readAsText(file);
      }

      dropArea2.textContent = file.name;

      };

      input.click();
      }
      
      
      
    </script>
    <center>
    <div id="check">
    <input type="checkbox" id="checkbox1" name="checkbox1" checked> sequential<br>
    <input type="checkbox" id="checkbox2" name="checkbox2"> rewiring<br>
    <input type="checkbox" id="checkbox3" name="checkbox3"> rewiring & reverse<br>
    <input type="checkbox" id="checkbox4" name="checkbox4"> reverse constrained<br>
    </left>
    </div>
    </center>
    <p>      
    <script>
    const checkbox1 = document.getElementById("checkbox1");
    const checkbox2 = document.getElementById("checkbox2");
    const checkbox3 = document.getElementById("checkbox3");
    const checkbox4 = document.getElementById("checkbox4");


    let mode="s";
    checkbox1.addEventListener("click", () => {
    if (checkbox1.checked) {

    mode = "s";
    checkbox2.checked = false;
    checkbox3.checked = false;
    checkbox4.checked = false;
    }
    });
        
    checkbox2.addEventListener("click", () => {
    if (checkbox2.checked) {

    mode = "w";
    checkbox1.checked = false;
    checkbox3.checked = false;
    checkbox4.checked = false;
    }
    });

    checkbox3.addEventListener("click", () => {
    if (checkbox3.checked) {
    
    mode = "r";
    checkbox1.checked = false;
    checkbox2.checked = false;
    checkbox4.checked = false;
    }
    });

    checkbox4.addEventListener("click", () => {
    if (checkbox4.checked) {
    mode = "R"
    checkbox1.checked = false;
    checkbox2.checked = false;
    checkbox3.checked = false;    
    }
    });
    </script>
    <center>
    <p id="status"></p>
    <div id="spinner-container">
      <div class="loading-spinner"></div>
    </div>
    </center>
    <p>
    <center><button id="my-button">Run MICAN</button></center>
    <script type="module" src="https://cdn.jsdelivr.net/pyodide/v0.22.1/full/pyodide.js"></script>
    <p>
      <center><button id="downloadBtn" style="display: none;">Download</button><center>
	  <p>
    <script type="module">
      let data=""
      let pyodide = await loadPyodide();
      ///import { loadPyodide} from "./pyodide/pyodide.mjs";      
      await pyodide.loadPackage("https://github.com/yakomaxa/mobileMICAN/raw/main/MICAN-1.0-cp39-cp39-emscripten_3_1_31_wasm32.whl/MICAN-1.0-cp39-cp39-emscripten_3_1_31_wasm32.whl");
      await loadingExecution();

      async function main(pdb1,filename1,pdb2,filename2,mode) {
     
      await pyodide.FS.writeFile(filename1, pdb1);            
      await pyodide.FS.writeFile(filename2, pdb2);      
            
      await pyodide.globals.set("x",mode);
      await pyodide.globals.set("fname1",filename1);
      await pyodide.globals.set("fname2",filename2);     

      await pyodide.runPython(`
      import MICAN                
      MICAN.mican(fname1,fname2,x)

      import io
      import os
      import tarfile
    
      file_names = ['/output.pdb', '/output.txt', '/output2.txt','/output.ras','/output.ali','/output.mat','/output_MODEL1.cif','/output_MODEL2.cif','/output.pml'];
      buf = io.BytesIO()
      tar = tarfile.open(fileobj=buf, mode='w')
      for file_name in file_names:
       file_path = file_name 
       with open(file_path, 'rb') as f:
        info = tar.gettarinfo(arcname=file_name, fileobj=f)
        tar.addfile(info, f)
      tar.close()
      with open('/outputs.tar', 'wb') as f:
       f.write(buf.getvalue())      
      `)

      var downloadBtn = document.getElementById('downloadBtn');
      downloadBtn.addEventListener('click', async function() {
      var data = await pyodide.FS.readFile('/outputs.tar');
      var blob = new Blob([data], { type: 'application/octet-stream' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url;
      link.download = 'outputs.tar'; // Change the filename as needed
      document.body.appendChild(link); // Add link to DOM
      link.click();
      document.body.removeChild(link); // Remove link from DOM
      URL.revokeObjectURL(url); // Clean up object URL
      document.getElementById('downloadBtn').style.display = 'none';
      });

      data = await pyodide.FS.readFile('/output.pdb',{ encoding: 'utf8' });
     
      }



      const myButton = document.getElementById('my-button');
      myButton.addEventListener('click', async function(){

      const status = document.getElementById('status');
      startExecution();
      setTimeout(async () => {
      try {
      await main(pdb1, filename1, pdb2, filename2, mode);
      await launchViewer(data);
      await stopExecution();
      document.getElementById('downloadBtn').style.display = 'block';
      document.getElementById('my-button').style.display = 'block';
      } catch (error) {
      await errorExecution();
      document.getElementById('my-button').style.display = 'block';
      }
      }, 100);
      })
      
       
    </script>
    <script src="https://cdn.jsdelivr.net/npm/molstar@3.31.2/build/viewer/molstar.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/molstar@3.31.2/build/viewer/molstar.min.css" rel="stylesheet">
    <center><div id="app"></div></center>
    <script>
      
      function launchViewer(data){
      molstar.Viewer.create('app', {
      layoutIsExpanded: false,
      layoutShowControls: false,
      layoutShowRemoteState: false,
      layoutShowSequence: true,
      layoutShowLog: false,
      layoutShowLeftPanel: true,

      viewportShowExpand: false,
      viewportShowSelectionMode: false,
      viewportShowAnimation: false,

      pdbProvider: 'rcsb',
      emdbProvider: 'rcsb',
      }).then(viewer => { viewer.loadStructureFromData(data, 'pdb')})
      }

    </script>

    <script>
      const spinner = document.getElementById('spinner-container');
      const status = document.getElementById('status');
      
      function loadingExecution() {
      spinner.style.display = 'none';
      status.textContent = 'Loading complete. Awaiting MICAN execution.';
      }

      function startExecution() {
      document.getElementById('my-button').style.display = 'none';
      spinner.style.display = 'block';
      status.textContent = 'MICAN execution in progress...';
      }

      function stopExecution() {
      spinner.style.display = 'none';
      status.textContent = 'Execution complete. Awaiting next run.';
      }

      function errorExecution() {
      spinner.style.display = 'none';
      status.textContent = 'Error occurred. Awaiting next run.';
      }
      
    </script>  
</html>
